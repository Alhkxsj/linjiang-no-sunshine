hserve 项目技术规格与开发路线图

一、 项目概述

hserve 是一个专为Termux环境设计的零配置HTTPS静态文件服务器。其核心特点是一次性生成自签名证书，并自动配置Termux环境以实现开箱即用的安全访问。项目采用单一可执行文件，通过子命令提供完整功能。

二、 核心设计原则

1. 证书一次性生成：所有证书仅在绝对必要时生成一次，永久存储于私有目录，后续操作均为复制和使用。
2. 单一二进制文件：将证书管理、服务器功能合并为一个可执行文件 (hserve)，通过子命令调用。
3. Termux环境优先：默认确保HTTPS服务在Termux内部生态（如curl, wget）中可被无缝信任，对安卓系统级安装提供明确引导。
4. 配置即代码：通过命令行参数提供清晰、明确的功能控制，无需配置文件。

三、 详细开发阶段与任务

第一阶段：项目重构与合并 (基础) ✅ 已完成

1. 代码结构重组
   · 目标：创建标准的Go项目布局，合并证书生成逻辑。
   · 任务：
     · 创建 cmd/hserve/main.go 作为唯一入口。✅
     · 将原有证书生成逻辑移至 internal/certmanager/ 包。✅
     · 将原有服务器逻辑移至 internal/server/ 包。✅
     · 更新 go.mod 模块名为 github.com/Alhkxsj/hserve。✅
2. 实现命令行框架
   · 目标：使用 cobra 库搭建坚实的子命令框架。
   · 任务：
     · 定义根命令 hserve。✅
     · 实现 --version, --help 全局标志。✅
     · 搭建 子命令的骨架。✅

第二阶段：实现核心证书生命周期 (关键) ✅ 已完成

1. 设计证书存储策略
   · 目标：确立“一次生成，永久使用”的存储机制。
   · 任务：
     · 定义证书主仓库：$PREFIX/etc/hserve/certs/ (用于存放CA证书 ca.crt、密钥 ca.key、服务器证书 server.crt 等)。✅
     · 在 internal/certmanager 包中实现检测逻辑：检查主仓库证书是否齐全。✅
2. 实现 gen-cert 子命令
   · 目标：安全地生成自签名证书链。
   · 任务：
     · 命令执行时，检测主仓库。若证书已存在，则提示“证书已存在，跳过生成”并退出。✅
     · 若不存在，则生成CA与服务器证书，保存至主仓库，并输出生成路径。✅
     · 支持 --force 标志以强制重新生成（覆盖前需确认）。✅
3. 实现 install-ca 子命令
   · 目标：将CA证书部署到Termux信任库。
   · 任务：
     · 检测 $PREFIX/etc/tls/certs/ 目录是否存在，若不存在则创建。✅
     · 将主仓库中的 ca.crt 复制或链接到该目录。✅
     · 输出明确的成功/失败信息。✅
4. 实现 export-ca 子命令
   · 目标：为用户手动安装CA证书到安卓系统提供便利。
   · 任务：
     · 将主仓库中的 ca.crt 复制到用户指定的目录。✅
     · 在复制后，在屏幕上打印清晰、醒目的操作指南，指导用户如何在安卓设置中安装此证书文件。✅
  
第三阶段：增强服务器功能 (功能) ✅ 已完成

1. 实现 serve 子命令及其核心功能
   · 目标：启动安全的静态文件服务器。
   · 智能启动逻辑：
     · 当用户执行 hserve serve 时，自动检测主仓库证书。✅
     · 若证书不存在，自动静默调用 gen-cert 和 install-ca 的逻辑，实现真正的零配置启动。✅
   · 实现访问白名单：
     · 增加 --allow 标志，可多次指定，参数为文件或目录的绝对路径。✅
     · 在HTTP请求处理中，校验请求路径是否位于任一白名单路径下。若否，返回 403 Forbidden。✅
   · 支持外挂证书：
     · 增加 --tls-cert-file 和 --tls-key-file 标志。✅
     · 当提供此参数时，程序使用指定证书，并跳过所有内置证书的自动生成与安装逻辑。✅

第四阶段：优化与收尾 (抛光) ✅ 已完成

1. 实现国际化 (i18n)
   · 目标：支持中英文输出。
   · 任务：
     · 实现内部 i18n 包管理翻译。✅
     · 将所有用户输出信息提取到 i18n 包中。✅
     · 根据环境变量 LANG 自动切换语言。✅
2. 打包与集成自动化
   · 目标：确保从源码到.deb包的流畅体验。
   · 任务：
     · 完善 build.sh 脚本，实现多架构（aarch64, arm, i686, x86_64）交叉编译。✅
     · 编写 deb 打包脚本，确保 Depends: 包含 openssl。✅
     · 实现自动安装后脚本，用于初始化证书。✅
3. 全面代码审查与测试
   · 目标：提升代码质量与稳定性。
   · 任务：
     · 审查所有错误处理路径，确保用户获得友好提示。✅
     · 进行基础单元测试，重点测试证书生成、白名单校验等核心模块。
     · 在纯净的Termux环境中进行端到端安装与功能测试。
     · 更新 README.md，包含新架构说明、所有子命令详解及使用范例。✅

四、 重点注意事项

· 权限管理：创建 $PREFIX/etc/hserve/ 等目录时，应设置合理的权限（如 0750），确保私钥安全。
· 路径安全：处理白名单路径时，必须解析并检查用户输入的路径，防止目录遍历攻击。
· 输出友好：所有控制台输出，尤其是错误信息，必须清晰、可操作。在 export-ca 后打印的安卓证书安装指南至关重要。

五、 项目完成状态

hserve 项目现已完全实现所有计划功能，包括：

- 统一的命令行界面（gen-cert, serve, install-ca, export-ca）
- 智能证书管理与自动部署
- 访问白名单控制
- 多语言支持
- 自动化构建与打包
- 完整的错误处理和用户提示
